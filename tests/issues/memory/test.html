<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
</head>
<body>
<script>
var leak = true;
function leakOn() {leak = true;}
function leakOff() {leak = false;}
</script>
<form>
<input type="radio" name="leak" value="on" checked onclick="leakOn()"/>Leak On<br />
<input type="radio" name="leak" value="off" onclick="leakOff()"/>Leak Off
</form>

<button id="allocateString">Allocate String</button> Click this button to allocate some strings.<br/>
<button id="loadImage">Load Image</button> Click this button to load an image.<br/>
<button id="fakeEdit">Fake Edit</button> Click this button to fake an edit.<br/>
<div id="imageBox" style="height: 100px"></div>
<div id="editMe"></div>

<script type="text/javascript">
var button1 = document.getElementById("allocateString");
var button2 = document.getElementById("loadImage");
button1.addEventListener("click", onAllocateString, false);
button2.addEventListener("click", onLoadImage, false);
var editButton = document.getElementById("fakeEdit");
editButton.addEventListener('click', onEdit, false);

var arr = [];
function onAllocateString()
{
    var data = "";
    for (var i=0; i<1000; i++)
        data += "01234567890123456789012345678901234567890123456789";
    arr.push(data);
    var button = document.getElementById("loadImage");
    button.innerHMTL = "Allocate String "+arr.length;
    if (!leak)
        arr.pop();
    return data;
}

var images = [];
function onLoadImage()
{
    var box = document.getElementById("imageBox");
    var button = document.getElementById("loadImage");
    button.innerHTML = "Load Image";

    var image = new Image();
    image.width = 30;
    image.height = 30;
    image.onload = function() {
        button.innerHTML = "Load Image DONE";
    };
    image.src = "http://getfirebug.com/header.png?random="+Math.random();
    images.push(image);

    box.appendChild(image);
    button.innerHTML = "Load Image ...";

    if (!leak)
        images.pop();
}

var EventBroadcaster =
{
    hashTableOfCallbacks: {},

    registerListenerForEvent: function(eventName /* string */, callback)
    {
        if (!EventBroadcaster.hashTableOfCallbacks[eventName])
            EventBroadcaster.hashTableOfCallbacks[eventName] = [];
        EventBroadcaster.hashTableOfCallbacks[eventName].push(callback);
    },
    unregisterListenerForEvent: function(eventName /* string */, callback)
    {
        var callbacks = EventBroadcaster.hashTableOfCallbacks[eventName];
        if (callbacks)
        {
            var i = EventBroadcaster.hashTableOfCallbacks[eventName].indexOf(callback);
            if (i >= 0)
                  EventBroadcaster.hashTableOfCallbacks[eventName].splice(i,1);

            if (!EventBroadcaster.hashTableOfCallbacks[eventName].length)
                delete EventBroadcaster.hashTableOfCallbacks[eventName];
        }
    },
    runListenersForEvent: function(eventName /* string */)
    {
        var callbacks = EventBroadcaster.hashTableOfCallbacks[eventName];
        if (callbacks)
        {
            for (var i = 0; i < callbacks.length; i++)
            {
                callbacks[i].apply(null, [eventName]);
            }
        }
    },
};
var undoStack = [];
function aTestCallback(event)
{
    var editMe = document.getElementById('editMe');
    var span = document.createElement('span');
    span.innerHTML = event+" "+onAllocateString();
    editMe.appendChild(span);
    //console.log("aTestCallback set "+editMe.innerHTML);
    if (leak)
        undoStack.push(span);
    editMe.removeChild(span);
}

function onEdit()
{
    var aBunch = 10;
    for (var i = 0; i < aBunch; i++)
        EventBroadcaster.registerListenerForEvent("edit", aTestCallback);

    EventBroadcaster.runListenersForEvent("edit");

    if (leak)
        aBunch = aBunch/2;

    for (var i = 0; i < aBunch; i++)
        EventBroadcaster.unregisterListenerForEvent("edit", aTestCallback);
}

// Test page load profiling.
onAllocateString();
onLoadImage();
onEdit();
</script>

</body>
</html>
