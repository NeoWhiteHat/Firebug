<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <script type="text/javascript" src="env.js" ></script>
    <script type="text/javascript" src="chrome://firebug/content/domplate.js" ></script>
    <script type="text/javascript" src="testList.js" ></script>
    <link rel="stylesheet" href="testRunner.css" type="text/css"/>
    <title>Firebug Test Runner</title>
</head>
<body>
<h1>Firebug Test Runner</h1>
<p>Use this page to run Firebug automated tests.<br/>
<ul>
    <li>Firebug and Fireunit must be installed.</li>
    <li><i>Enable Privileges</i> option in Fireunit must be on.</li>
    <li>All panels in Firebug must be <i>always</i> enabled.</li>
</ul>
</p>

<button id="runAll" onclick="runAllTests()" style="display:none">Run All</button>
<br/><br/>
<div id="content"/>
<script>
var content = document.getElementById("content");
var runAll = document.getElementById("runAll");
if (typeof fireunit != "undefined") {
if (fireunit.forceHttp()) { with (FBL) {
//-----------------------------------------------------------------------------

// The Run All button can be visible now.
runAll.style.display = "block";

// Run all tests in one test suite.
function runAllTests() {
    runTests(testList);
}

function runTests(tests) {
    var temp = [];
    for (var i=0; i<tests.length; i++)
        temp.push(tests[i].uri);
    fireunit.runTests.apply(fireunit, temp);
}

// Test List Template
//-----------------------------------------------------------------------------

var CategoryList = domplate(
{
    tableTag:
        TABLE({"class": "categoryTable", cellpadding: 0, cellspacing: 0, onclick: "$onClick"},
            TBODY(
                FOR("category", "$testList|categoryIterator",
                    TR({"class": "testCategoryRow", _repObject: "$category"},
                        TD({"class": "categoryName testCategoryCol"},
                            SPAN({"class": "testCategoryName"},
                                "$category|getCategoryName"
                            ),
                            SPAN({"class": "testCategoryCount"},
                                "$category|getCategoryCount"
                            ),
                            SPAN({"class": "categoryAction testLink", onclick: "$onCategoryClick"},
                                SPAN("Run")
                            )
                        )
                    )
                )
            )
        ),

    categoryBodyTag:
        TR({"class": "categoryBodyRow", _repObject: "$category"},
            TD({"class": "categoryBodyCol", colspan: 1})
        ),

    categoryIterator: function(testList)
    {
        var map = [];
        var categories = [];
        for (var i=0; i<testList.length; i++) {
            var test = testList[i];
            var category = map[test.category];
            if (!category)
                categories.push(category = map[test.category] = {name: test.category, tests: []});
            category.tests.push(test);
        }
        return categories;
    },

    getCategoryName: function(category) {
        var n = category.name;
        return n.charAt(0).toUpperCase() + n.substr(1).toLowerCase();
    },

    getCategoryCount: function(category) 
    {
        return "(" + category.tests.length + ")";
    },

    onCategoryClick: function(event) {
        if (isLeftClick(event)) {
            var row = getAncestorByClass(event.target, "testCategoryRow");
            if (row) {
                cancelEvent(event);
                runTests(row.repObject.tests);
            }
        }
    },

    onClick: function(event)
    {
        if (isLeftClick(event)) {
            var row = getAncestorByClass(event.target, "testCategoryRow");
            if (row) {
                this.toggleRow(row);
                cancelEvent(event);
            }
        }
    },

    toggleRow: function(row)
    {
        var category = row.repObject;

        toggleClass(row, "opened");
        if (hasClass(row, "opened")) {
            var infoBodyRow = this.categoryBodyTag.insertRows({category: category}, row)[0];
            infoBodyRow.repObject = category;
            this.initBody(infoBodyRow);
        }
        else
        {
            var infoBodyRow = row.nextSibling;
            var netInfoBox = getElementByClass(infoBodyRow, "categoryBodyRow");
            row.parentNode.removeChild(infoBodyRow);
        }
    },

    initBody: function(infoBodyRow)
    {
        var category = infoBodyRow.repObject;
        TestList.tag.replace({tests: category.tests}, infoBodyRow.firstChild);
    },
});

//-----------------------------------------------------------------------------

var TestList = domplate(
{
    tag:
        TABLE({"class": "testTable", cellpadding: 0, cellspacing: 0},
            TBODY(
                FOR("test", "$tests",
                    TR({"class": "testListRow", _repObject: "$test"},
                        TD({"class": "testListCol testUri"},
                            SPAN({"class": "testLink", onclick: "$onTestClick"},
                                SPAN("$test.uri")
                            )
                        ),
                        TD({"class": "testListCol testDesc"},
                            SPAN("$test.desc")
                        )
                    )
                )
            )
        ),

    onTestClick: function(event)
    {
        if (isLeftClick(event))
        {
            var row = getAncestorByClass(event.target, "testListRow");
            var testObj = row.repObject;
            fireunit.runTests(testObj.uri);
            cancelEvent(event);
        }
    }
});

//-----------------------------------------------------------------------------

// Build runner UI
CategoryList.tableTag.replace({testList: testList}, content);

//-----------------------------------------------------------------------------
}}}
else {
    content.innerHTML ="<span style='color:red'>Fireunit must be installed.</span>";
} 
</script>
</body>
</html>
