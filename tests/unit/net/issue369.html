<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<script src="../env.js" type="text/javascript"></script>
<script src="utils.js" type="text/javascript"></script>
<script>
enablePrivilege("UniversalXPConnect");

var index = location.pathname.lastIndexOf(".");
var uriFileName = location.pathname.substr(0, index);

var jsonString = "{'firstName':'John','lastName':'Smith','address':{" +
    "'streetAddress':'21 2nd Street','city':'New York','state':'NY','postalCode':10021}," +
    "'phoneNumbers':['212 555-1234','646 555-4567']}";

var textContent = "addressObject streetAddress=21 2nd Street city=New York state=NY" +
    "firstName\"John\"lastName\"Smith\"phoneNumbers[\"212 555-1234\", \"646 555-4567\" 0=" +
    "212 555-1234 1=646 555-4567]";

// JSON response #1
function requestHandler1(metadata, response) {
    response.setHeader("Content-Type", "application/json", false);
    response.write(jsonString);
} 

// JSON response #2
function requestHandler2(metadata, response) {
    response.setHeader("Content-Type", "application/json", false);
    response.write("somefunc(" + jsonString + ")");
} 

// JSON response #3
function requestHandler3(metadata, response) {
    response.setHeader("Content-Type", "application/json", false);
    response.write("/*-secure-\n" + jsonString + "\n*/");
} 

// JSON response #4
function requestHandler4(metadata, response) {
    response.setHeader("Content-Type", "application/json", false);
    response.write("while (true); &&&START&&& " + jsonString + " &&&END&&&");
} 

// JSON response #5
function requestHandler5(metadata, response) {
    response.setHeader("Content-Type", "application/json", false);
    response.write("var myObject = " + jsonString+ ";");
} 

fireunit.registerPathHandler(uriFileName + "-1.txt", requestHandler1);
fireunit.registerPathHandler(uriFileName + "-2.txt", requestHandler2);
fireunit.registerPathHandler(uriFileName + "-3.txt", requestHandler3);
fireunit.registerPathHandler(uriFileName + "-4.txt", requestHandler4);

// xxxHonza: Not implemented yet.
//fireunit.registerPathHandler(uriFileName + "-5.txt", requestHandler5);

var counter = 1;
function requestHandler(request) 
{
    enablePrivilege("UniversalXPConnect");
    FBTrace.sysout("fireunit.issue369.jsonViewer (" + counter + "), " +
        request.channel.URI.path, request);

    Firebug.showBar(true);
    FirebugChrome.selectPanel("net");

    var panelNode = fireunit.panel("net");
    expandNetRows(panelNode, "netRow", "category-xhr");
    expandNetTabs(panelNode, "netInfoJSONTab");

    var jsonBody = FBL.getElementByClass(panelNode, "netInfoJSONText", "netInfoText");
    var domTable = FBL.getElementByClass(jsonBody, "domTable");
    fireunit.ok(domTable, "JSON tree must exist for: " + request.channel.URI.path);
    fireunit.ok(textContent, domTable.textContent, "JSON data must be properly displayed.");

    counter++;

    // Execute next request (there is five test-cases) or finish the test.
    if (counter <= 4) {
        Firebug.NetMonitor.clear(FirebugContext);
        makeRequest("GET", "issue369-" + counter + ".txt", requestHandler);
    } else {
        FBTrace.sysout("fireunit.issue369.DONE");
        fireunit.testDone();
    }
};

makeRequest("GET", "issue369-1.txt", requestHandler);
</script>
</head>
<body>
<h1>Test for Issue #369</h1>
</body>
</html>
