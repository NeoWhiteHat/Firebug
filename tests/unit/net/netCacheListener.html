<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<script src="../env.js" type="text/javascript"></script>
<script src="utils.js" type="text/javascript"></script>
<script>
enablePrivilege("UniversalXPConnect");

var responseBody = "Response for netCacheListener.html test";

var onStoreResponse = false;
var netCacheListener = {
    onStoreResponse: function(win, request, lines) {
        fireunit.ok(!onStoreResponse, "onStart must be called just once");
        fireunit.compare(responseBody, lines.join(), 
            "Cached response verified.");
        onStoreResponse = true;
    }
}

function requestHandler(metadata, response) {
    response.setHeader("Content-Type", "text/plain", false);
    response.write(responseBody);
} 
fireunit.registerPathHandler("/netCacheListener.txt", requestHandler);

enablePrivilege("UniversalXPConnect");
var sourceCache = FirebugContext.sourceCache;

// This test is valid only for Firebug 1.3 running with Firefox 3.0.4 
if ("addListener" in sourceCache) {
    sourceCache.addListener(netCacheListener);
    makeRequest("GET", localHostURI + "netCacheListener.txt", function(request) {
        enablePrivilege("UniversalXPConnect");
        FBTrace.sysout("fireunit.netCacheListener.check callbacks from Firebug.TabCache.");
        fireunit.ok(onStoreResponse, "onStoreResponse callback verified");

        // Finish test
        sourceCache.removeListener(netCacheListener);
        FBTrace.sysout("fireunit.netCacheListener.DONE");
        fireunit.testDone();
    });
}
else {
    fireunit.testDone();
}
</script>
</head>
<body>
<h1>Test for Firebug.TabCache listener.</h1>
</body>
</html>
