<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<script src="env.js" type="text/javascript"></script>
<script src="utils.js" type="text/javascript"></script>
<script>
enablePrivilege("UniversalXPConnect");

var request = new XMLHttpRequest();
request.onreadystatechange = function () {
    if (request.readyState == 4 && request.status == 200)
        setTimeout(function() {
            checkCopyLocationWithParametersAction(request);
        }, layoutTimeout);
};
request.open("POST", "issue1308.txt", true);
request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
request.send("param1=1+%2B 2");

function checkCopyLocationWithParametersAction(request)
{
    enablePrivilege("UniversalXPConnect");
    FBTrace.sysout("fireunit.issue1308.checkCopyLocationWithParametersAction", request);

    // Open Firebug UI and activate Net panel.
    Firebug.showBar(true);
    FirebugChrome.selectPanel("net");

    // Expand the test request with params
    var panelNode = fireunit.panel("net");
    var netRow = FBL.getElementByClass(panelNode, "netRow", "category-xhr", "hasHeaders", "loaded");
    if (!netRow) {
        fireunit.testDone();
        return;
    }

    // Test the "Copy Location With Parameters action" available in the context menu
    // for specific Net panel entry.
    var netPanel = FirebugContext.getPanel("net");
    netPanel.copyParams(netRow.repObject);

    // Get data from the clipboard.
    var Ci = Components.interfaces;
    var clipboard = FBL.CCSV("@mozilla.org/widget/clipboard;1", "nsIClipboard");
    var trans = FBL.CCIN("@mozilla.org/widget/transferable;1", "nsITransferable");
    trans.addDataFlavor("text/unicode");
    clipboard.getData(trans, Ci.nsIClipboard.kGlobalClipboard);
    var str = new Object();
    var strLength = new Object();
    trans.getTransferData("text/unicode", str, strLength);
    str = str.value.QueryInterface(Ci.nsISupportsString);
    var actual = str.data.substring(0, strLength.value / 2);

    // Complete expected result.
    var index = location.href.lastIndexOf(".");
    var requestUri = location.href.substr(0, index) + ".txt";
    var expected = requestUri + "?param1=1%20%2B%202";

    // Verification.
    fireunit.compare(expected, actual, "Veriry that the copied URL is properly encoded.");

    // Finish test
    FBTrace.sysout("fireunit.issue1308.DONE");
    fireunit.testDone();
}
</script>
</head>
<body>
<h1>Test Case for Issue #1308</h1>
</body>
</html>
