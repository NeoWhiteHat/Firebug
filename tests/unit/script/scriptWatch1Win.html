<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<script src="env.js" type="text/javascript"></script>
<script type = "text/javascript">
// Handle error that occurs on the page.
function onError(errType, errURL, errLineNum)
{
    if (errType != "animal is undefined")
        return false;

    if (window.opener.reloaded) {
        FBTrace.sysout("scriptWatch1Win.onerror (the second time): " + errType + " (" + 
            errLineNum + ")" + ", " + errURL);
            return false;
    }

    FBTrace.sysout("scriptWatch1Win.onerror (the first time): " + errType + " (" + 
        errLineNum + ")" + ", " + errURL);

    setTimeout(openFirebugConsole, 3000);

    // Make sure the error is processed with Firebug.
    return false;
}

function openFirebugConsole()
{
    enablePrivilege("UniversalXPConnect");

    // Make sure the Net panel's UI is there.
    Firebug.showBar(true);
    FirebugChrome.selectPanel("console");
    var consoleNode = fireunit.panel("console");

    FBTrace.sysout("scriptWatch1Win.openFirebugConsole: console panel opened");

    // Step 2: switch to Script panel
    setTimeout(clickOnError, 3000);
}

function clickOnError()
{
    enablePrivilege("UniversalXPConnect");

    // Jump into the script view from console.
    var consoleNode = fireunit.panel("console");
    var errorRow = FBL.getElementByClass(consoleNode, "logRow", "logRow-errorMessage");
    var errorLink = FBL.getElementByClass(errorRow, "errorSource");
    fireunit.click(errorLink);

    FBTrace.sysout("scriptWatch1Win.openFirebugConsole: error link clicked", errorLink);

    // Step 3: Setup a breakpoint.
    setTimeout(addBreakpoint, 3000);
}

function addBreakpoint()
{
    setBreakpoint();

    // Dispatch event about break in the debugger.
    var event = document.createEvent("Events");
    event.initEvent("FirebugTestCallback", true, false);
    window.opener.channel.dispatchEvent(event);

    FBTrace.sysout("scriptWatch1Win.openFirebugConsole: going to reload");

    // Step 4: Reload the page
    location.reload(true);
    //window.fireunit.key(testWindow.fireunit.chromeID("nav-bar"), 116);
}

function setBreakpoint()
{
    enablePrivilege("UniversalXPConnect");

    var scriptNode = fireunit.panel("script");
    var sourceBox = FBL.getElementsByClass(scriptNode, "sourceBox")[1];
    var sourceViewport = FBL.getElementByClass(scriptNode, "sourceViewport");
    var sourceRow = sourceViewport.childNodes[1];
    var sourceLine = sourceRow.firstChild;
    fireunit.mouseDown(sourceLine);

    FBTrace.sysout("scriptWatch1Win.setBreakpoint: line clicked", sourceLine);
}

window.onerror = onError;

// Load the code dynamically
var href = window.location.href;
var url = href.substr(0, href.length - 4) + "js";
var req = new XMLHttpRequest();
req.open("GET", url, false);
req.send(null);
eval(req.responseText); // line 23

// Now use the code
prod(new duck());
prod(new cat());

// Step 1: call point of error
prod(); 
</script>
</head>
<body/>
</html>
